---
title: "Biostat 203B Homework 2"
subtitle: Due Feb 6 @ 11:59PM
author: Jonathan King
output: 
  html_document:
    toc: true
    toc_depth: 4 
---

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r setup, message=F}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, cache.lazy = FALSE)
knitr::opts_knit$set(root.dir = '/mnt/mimiciv/1.0')
library(tidyverse)
library(data.table)
library(lubridate)
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/mnt/mimiciv/1.0"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "/Users/huazhou/Documents/Box Sync/MIMIC/mimic-iv-1.0"
}
```

In this exercise, we use tidyverse (ggpot2, dplyr, etc) to explore the [MIMIC-IV](https://mimic.mit.edu/docs/iv/) data introduced in [homework 1](https://ucla-biostat-203b.github.io/2022winter/hw/hw1/hw1.html) and to build a cohort of ICU stays.

```{r}
# tree -s -L 2 /Users/huazhou/Documents/Box\ Sync/MIMIC/mimic-iv-1.0
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading plain text data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. 

Which function is fastest? Is there difference in the (default) parsed data types? (Hint: R function `system.time` measures run times.)

For later questions, we stick to the tidyverse.

### Solution

```{r}
# Compare run times of different file reading functions
system.time(read_1 <- read.csv("./core/admissions.csv.gz"))
system.time(read_2 <- read_csv("./core/admissions.csv.gz"))
system.time (read_3 <- fread("./core/admissions.csv.gz"))
# Check for differences in parsed data types
str(read_1)
str(read_2)
str (read_3)
```

`fread` is the fastest function overall. By default, `read.csv` parsed all character variables
and dates as factors, while both `read_csv` and `fread` correctly parsed character variables 
and parsed dates as POSIXct variables. Also, 'read_csv' parsed id numbers as numeric, while the other
two file reading functions parsed the id numbers as integers.



## Q2. ICU stays

`icustays.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/icustays.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `icustatys.csv.gz` as a tibble `icustays_tble`. 

### Solution

```{r}
icustays_tble <- read_csv ("./icu/icustays.csv.gz")
icustays_tble
```

2. How many unique `subject_id`? Can a `subject_id` have multiple ICU stays? 

### Solution
```{r}
icustays_tble %>%
  group_by(subject_id) %>%
  summarise (number_of_stays = n_distinct(stay_id)) %>%
  arrange (desc(number_of_stays))

```

There are 53,150 unique `subject_id`, and they can have multiple ICU stays.

3. For each `subject_id`, let's only keep the first ICU stay in the tibble `icustays_tble`.

## Solution

```{r}
icustays_tble <- icustays_tble %>%
  group_by(subject_id) %>% 
  arrange (intime) %>% 
  distinct(subject_id, .keep_all = TRUE)
icustays_tble
```
## Q3. `admission` data

Information of the patients admitted into hospital is available in `admissions.csv.gz`. See <https://mimic.mit.edu/docs/iv/modules/core/admissions/> for details of each field in this file. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/core/admissions.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `admissions.csv.gz` as a tibble `admissions_tble`.
### Solution

```{r}
admissions_tble <- read_csv("./core/admissions.csv.gz")
```

2. Let's only keep the admissions that have a match in `icustays_tble` according to `subject_id` and `hadmi_id`.

### Solution

```{r}
admissions_tble <- semi_join(admissions_tble,
  icustays_tble, 
  by = c("subject_id", "hadm_id"))
```
3. Summarize the following variables by graphics. 

- admission year  
- admission month  
- admission month day  
- admission week day  
- admission hour (anything unusual?)  

### Solution

```{r}
admissions_tble %>% 
  mutate(year = year(admittime)) %>% 
  ggplot() +
  geom_histogram (mapping = aes(x = year), fill = "skyblue", binwidth = 15) +
  labs(title = " ICU Admission by Year", x = "Year", y = "Admission Count") +
  theme(plot.title = element_text(hjust = 0.5))
admissions_tble %>% 
  mutate(month = month(admittime, label = TRUE)) %>% 
  ggplot() +
  geom_bar(mapping = aes(x = month, fill = month)) +
  scale_fill_brewer(palette = "Set3") + 
  theme(legend.position = "none") +
  labs(title = "ICU Admissions by Month", x = "Month", y = "Admission Count") +
  theme(plot.title = element_text(hjust = 0.5))
admissions_tble %>% 
  mutate(mday = mday(admittime)) %>% 
  ggplot() +
  geom_histogram(mapping = aes(x=mday), fill = "lightblue", binwidth = 5) +
  labs(title = "ICU Admissions by Day of the Month", 
       x = "Day of the Month",
       y = "Admission Count"
       ) +
  theme(plot.title = element_text(hjust = 0.5))
admissions_tble %>% 
  mutate(wday = wday(admittime, label = TRUE)) %>% 
  ggplot() +
  geom_bar(mapping = aes(x = wday, fill = wday)) +
  theme(legend.position = "none") +
  labs(title = "ICU Admissions by Day of the Week", 
       x = "Day of the Week",
       y = "Admission Count"
       ) +
  theme(plot.title = element_text(hjust = 0.5))
admissions_tble %>% 
  mutate(hour = hour(admittime)) %>% 
  ggplot() +
  geom_bar(mapping = aes(x = hour)) +
  theme(legend.position = "none") +
  labs(title = "ICU Admissions by Hour", x = "Hour", y = "Admission Count") +
  theme(plot.title = element_text(hjust = 0.5))
```

- The 12 a.m. hour was when the most patients were admitted. Fewer patients
are admitted in the morning hours after, except for an usual spike in the 7 a.m. hour.

## Q4. `patients` data

Patient information is available in `patients.csv.gz`. See <https://mimic.mit.edu/docs/iv/modules/core/patients/> for details of each field in this file. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/core/patients.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Import `patients.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/core/patients/>) as a tibble `patients_tble` and only keep the patients who have a match in `icustays_tble` (according to `subject_id`).

### Solution

```{r}
patients_tble <- read_csv("./core/patients.csv.gz")
patients_tble <- semi_join(patients_tble, icustays_tble)
```

2. Summarize variables `gender` and `anchor_age`, and explain any patterns you see.

### Solution

```{r}
ggplot(data = patients_tble) +
  geom_bar (aes(x = gender, fill = gender)) +
  theme(legend.position = "none") +
  labs(title = "Patient Gender", x = "Gender", y = "Patient Count") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot (data = patients_tble) +
  geom_histogram (
    aes(x= anchor_age), 
    fill = "orangered2", 
    binwidth = 5,
    center = 17.5
  ) +
  labs(title = "Patient Age", x = "Age (yrs.)", y = "Patient Count") +
  theme(plot.title = element_text(hjust = 0.5))
  
patients_tble %>%
  group_by(gender) %>%
  summarise(
    n = n(), 
    mean_age = mean(anchor_age), 
    median_age = median(anchor_age), 
    sd_age = sd(anchor_age),
    min = min(anchor_age),
    max = max(anchor_age)
  )
```

- Most patients were male and older than 60 with the highest number of patients being around 66-70 years old compared to any other age range.
Mean and median age were lower for male patients compared to female patients. 
Standard deviation in age was also lower for male patients.
Minimum patient age was 18 years old, and maximum patient age was 91 years old, so no data on minors were collected.
## Q5. Lab results

`labevents.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/hosp/labevents/>) contains all laboratory measurements for patients. The first 10 lines are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/hosp/labevents.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```
`d_labitems.csv.gz` is the dictionary of lab measurements. 
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/hosp/d_labitems.csv.gz")), 
    " | head"
    ), 
  intern = TRUE
)
```

1. Find how many rows are in `labevents.csv.gz`.

### Solution

```{bash}
zcat /mnt/mimiciv/1.0/hosp/labevents.csv.gz | tail -n+2 | wc -l 
```

2. We are interested in the lab measurements of creatinine (50912), potassium (50971), sodium (50983), chloride (50902), bicarbonate (50882), hematocrit (51221), white blood cell count (51301), glucose (50931), magnesium (50960), and calcium (50893). Retrieve a subset of `labevents.csv.gz` only containing these items for the patients in `icustays_tble` as a tibble `labevents_tble`. 

    Hint: `labevents.csv.gz` is a data file too big to be read in by the `read_csv` function in its default setting. Utilize the `col_select` and `lazy` options in the `read_csv` function to reduce the memory burden.
### Solution

```{r}
labevents_tble <- read_csv("./hosp/labevents_filtered_itemid.csv.gz")
labevents_dict <- read_csv ("./hosp/d_labitems.csv.gz")
labevents_tble <- labevents_tble %>%
  semi_join(icustays_tble) 
# categories <- unique(labevents_tble$itemid)
# categories
```

3. Further restrict `labevents_tble` to the first lab measurement during the ICU stay.

### Solution

```{r} 
chartime <- select(icustays_tble, subject_id, intime)
labevents_tble <- full_join(labevents_tble, chartime)
labevents_tble <-labevents_tble %>% 
   arrange (subject_id) %>%
  filter (charttime >= intime) %>%
  distinct (subject_id, itemid, .keep_all = TRUE) %>%
  inner_join(labevents_dict, by = "itemid") %>%
  select (subject_id, label, valuenum) %>%
  spread (label, valuenum)

labevents_tble
```

4. Summarize the lab measurements by appropriate numerics and graphics. 

### Solution

```{r}
#  labevents_dict <- labevents_dict %>%
#   select (itemid, label) %>%
#   filter(itemid %in% labevents_tble$itemid)
#  labevents_tble <- labevents_tble %>%
#   inner_join(labevents_dict, by = "itemid")
#   
# labevents_tble_wide %>% 
#   group_by(label) %>%
#   summarize (
#     n = n(),
#     mean = mean(valuenum, na.rm = TRUE), 
#     sd = sd(valuenum,na.rm = TRUE), 
#     median = median(valuenum,na.rm = TRUE),
#     min = min(valuenum,na.rm = TRUE),
#     max = max(valuenum, na.rm = TRUE))
# 
# labevents_tble_wide %>%
#   filter (valuenum < 200) %>%
#   ggplot() +
#   geom_histogram(aes(x = valuenum), bins = 10) +
#   facet_wrap(~ label, scales = "free") +
#   labs(title = "Lab Measurements", x = "Measurement Value") +
#   theme(plot.title = element_text(hjust = 0.5)) 
```

## Q6. Vitals from charted events

`chartevents.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `itemid` variable indicates a single measurement type in the database. The `value` variable is the value measured for `itemid`. The first 10 lines of `chartevents.csv.gz` are
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/chartevents.csv.gz")), 
    " | head"), 
  intern = TRUE
)
```
`d_items.csv.gz` (<https://mimic.mit.edu/docs/iv/modules/icu/d_items/>) is the dictionary for the `itemid` in `chartevents.csv.gz`. 
```{r}
system(
  str_c(
    "zcat < ", 
    shQuote(str_c(mimic_path, "/icu/d_items.csv.gz")), 
    " | head"), 
  intern = TRUE
)
```

1. We are interested in the vitals for ICU patients: heart rate (220045), mean non-invasive blood pressure (220181), systolic non-invasive blood pressure (220179), body temperature in Fahrenheit (223761), and respiratory rate (220210). Retrieve a subset of `chartevents.csv.gz` only containing these items for the patients in `icustays_tble` as a tibble `chartevents_tble`.

```{r}
chartevents_tble <- read_csv ("./icu/chartevents_filtered_itemid.csv.gz")
 chartevents_dict <- read_csv ("./icu/d_items.csv.gz")
chartevents_tble <- chartevents_tble %>%
  semi_join(icustays_tble, by = "subject_id") 
chartevents_tble

```
2. Further restrict `chartevents_tble` to the first vital measurement during the ICU stay. 

```{r}
# chartevents_tble <- distinct (chartevents_tble, hadm_id, .keep_all = TRUE)
# chartevents_tble
chartevents_tble <- left_join(chartevents_tble, chartime)
chartevents_tble
chartevents_tble <-chartevents_tble %>% 
  filter(charttime >= intime) %>%
  distinct(subject_id, itemid, .keep_all = TRUE) %>%
  arrange(subject_id) %>%
  inner_join(chartevents_dict, by = "itemid") %>%
  select (subject_id, label, valuenum) %>%
  spread (label, valuenum)
chartevents_tble
```
3. Summarize these vital measurements by appropriate numerics and graphics. 

```{r}
# 
# chartevents_tble %>% 
#  select(-subject_id) %>%
#   summarize_all(
#     list(n = n(),
#         mean = mean(), 
#         sd = sd(), 
#         median = median(),
#         min = min(),
#         max = max())
#   )
#     
# 
# chartevents_tble_wide_1 <- chartevents_tble_wide %>%
#   filter(label == "Temperature Fahrenheit") %>%
#   select(valuenum) %>%
#   arrange(valuenum)
# 
# chartevents_tble_wide$eliminate <-
#   (chartevents_tble_wide$label == "Temperature Fahrenheit") &
#   (chartevents_tble_wide$valuenum < 85)
# 
# # Remove outliers
# chartevents_tble_wide %>%
#   filter(valuenum <= 253) %>% 
#   filter(eliminate == FALSE) %>%
#   ggplot() +
#   geom_histogram(aes(x = valuenum), bins = 10) +
#   facet_wrap(~ label, scales = "free") +
#   labs(
#     title = "Chart Measurements", 
#     x = "Measurement Value", 
#     y = "Measurement Count" 
#   ) +
#   theme(plot.title = element_text(hjust = 0.5)) 
```

## Q7. Putting things together

Let us create a tibble `mimic_icu_cohort` for all ICU stays, where rows are  

- first ICU stay of each unique adult (age at admission > 18)

and columns contain at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- all variables in `patients.csv.gz`  
- first lab measurements during ICU stay  
- first vital measurements during ICU stay
- an indicator variable `thirty_day_mort` whether the patient died within 30 days of hospital admission (30 day mortality)

### Solution

```{r}
admissions_tble <- admissions_tble %>%
mutate(thirty_day_mort = ifelse(deathtime - admittime < 43200, 1, 0))
admissions_tble$thirty_day_mort[is.na(admissions_tble$thirty_day_mort)] <- 0
mimic_icu_cohort <- admissions_tble %>%
  inner_join(icustays_tble, by = "subject_id", "hadm_id") %>%
  inner_join(patients_tble) %>%
  left_join(labevents_tble) %>%
  inner_join(chartevents_tble) %>%
  filter(anchor_age > 18)
mimic_icu_cohort
  
```
## Q8. Exploratory data analysis (EDA)

Summarize following information using appropriate numerics or graphs.

- `thirty_day_mort` vs demographic variables (ethnicity, language, insurance, marital_status, gender, age at hospital admission)

- `thirty_day_mort` vs first lab measurements

- `thirty_day_mort` vs first vital measurements

- `thirty_day_mort` vs first ICU unit

